<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Cane Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load Firebase SDKs -->
    <script type="module">
        // Import Firebase services
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // -----------------------------------------------------------------
        // ⚠️ PASTE YOUR FIREBASE CONFIG HERE
        // (Get this from Firebase Project Settings > General > Your apps > Config)
        // -----------------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyAMZHKd1z9xatj6daLlvsSSzgRnCMK-quU",
            authDomain: "smart-cane-c916e.firebaseapp.com",
            projectId: "smart-cane-c916e",
            storageBucket: "smart-cane-c916e.firebasestorage.app",
            messagingSenderId: "413977422291",
            appId: "1:413977422291:web:dc2ddd2914c9327ea26726",
            measurementId: "G-XM6JGBQGKK"
        };
        // -----------------------------------------------------------------

        // --- Firebase Globals ---
        let db, auth, userId;
        let locationHistoryCollection, alertHistoryCollection;

        // --- ThingSpeak Config ---
        let channelId = '', readApiKey = '';
        let monitoringInterval;
        let lastEntryId = -1; // To track the last processed entry

        // --- DOM Elements ---
        let configScreen, dashboardScreen, startButton, channelIdInput, apiKeyInput;
        let errorBox, latDisplay, lngDisplay, lastUpdateDisplay, sosStatusBox, sosStatusText, loader;
        let locationHistoryList, alertHistoryList, mapIframe, mapLink;

        /**
         * Initializes Firebase and authenticates the user.
         */
        async function initFirebase() {
            try {
                if (firebaseConfig.apiKey.includes("...YOUR...KEY")) {
                    showError("Firebase config is missing. Please paste your keys into index.html.");
                    return;
                }
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                await signInAnonymously(auth);
                userId = auth.currentUser.uid;
                console.log("Firebase initialized and user signed in anonymously:", userId);

                // Correct Firestore path (odd number of segments)
                const dbPath = `users/${userId}`; 
                locationHistoryCollection = collection(db, `${dbPath}/locationHistory`);
                alertHistoryCollection = collection(db, `${dbPath}/alertHistory`);
                
                // Start listening for real-time history updates
                listenToHistory();

            } catch (err) {
                console.error("Firebase Init Error:", err);
                showError(`Firebase Error: ${err.message}`);
            }
        }

        /**
         * Listens for real-time updates to the history collections from Firebase.
         */
        function listenToHistory() {
            if (!locationHistoryCollection || !alertHistoryCollection) return;

            // Query for the last 10 location entries, ordered by time
            const locationQuery = query(locationHistoryCollection, orderBy("timestamp", "desc"), limit(10));
            onSnapshot(locationQuery, (snapshot) => {
                const locations = [];
                snapshot.forEach(doc => locations.push(doc.data()));
                renderLocationHistory(locations);
            }, (err) => console.error("Location snapshot error:", err));

            // Query for the last 10 alert entries, ordered by time
            const alertQuery = query(alertHistoryCollection, orderBy("timestamp", "desc"), limit(10));
            onSnapshot(alertQuery, (snapshot) => {
                const alerts = [];
                snapshot.forEach(doc => alerts.push(doc.data()));
                renderAlertHistory(alerts);
            }, (err) => console.error("Alert snapshot error:", err));
        }

        /**
         * Renders the location history list on the page.
         */
        function renderLocationHistory(locations) {
            locationHistoryList.innerHTML = ''; 
            if (locations.length === 0) {
                locationHistoryList.innerHTML = '<li class="text-gray-500">No location data saved yet.</li>';
                return;
            }
            locations.forEach(loc => { 
                const li = document.createElement('li');
                li.className = 'py-2 px-3 bg-white rounded-md mb-2 shadow-sm';
                const date = loc.timestamp ? new Date(loc.timestamp.seconds * 1000).toLocaleString() : 'Invalid Date';
                li.innerHTML = `
                    <span class="font-medium">${date}</span>
                    <span class="text-sm text-gray-600 block">Lat: ${loc.lat || 'N/A'}, Lng: ${loc.lng || 'N/A'}</span>
                `;
                locationHistoryList.appendChild(li);
            });
        }

        /**
         * Renders the alert history list on the page.
         */
        function renderAlertHistory(alerts) {
            alertHistoryList.innerHTML = ''; 
            if (alerts.length === 0) {
                alertHistoryList.innerHTML = '<li class="text-gray-500">No SOS alerts recorded.</li>';
                return;
            }
            alerts.forEach(alert => { 
                const li = document.createElement('li');
                li.className = 'py-2 px-3 bg-red-100 border-l-4 border-red-500 rounded-md mb-2 shadow-sm';
                const date = alert.timestamp ? new Date(alert.timestamp.seconds * 1000).toLocaleString() : 'Invalid Date';
                li.innerHTML = `<span class="font-medium text-red-700">SOS ALERT</span> <span class="text-sm text-gray-700">at ${date}</span>`;
                alertHistoryList.appendChild(li);
            });
        }

        /**
         * Fetches the latest data from ThingSpeak.
         */
        async function fetchFromThingSpeak() {
            if (!channelId || !readApiKey) {
                showError("Channel ID and API Key are required.");
                return;
            }
            
            loader.classList.remove('hidden'); 
            const url = `https://api.thingspeak.com/channels/${channelId}/feeds/last.json?api_key=${readApiKey}`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`ThingSpeak API error: ${response.status}`);
                
                const data = await response.json();

                if (data && data.entry_id && data.entry_id !== lastEntryId) {
                    lastEntryId = data.entry_id; 
                    
                    const lat = parseFloat(data.field1 || 0).toFixed(6);
                    const lng = parseFloat(data.field2 || 0).toFixed(6);
                    const sos = parseInt(data.field3, 10) || 0;
                    const timestamp = new Date(data.created_at || Date.now());

                    // Update all live UI elements
                    updateLiveUI(lat, lng, sos, timestamp);
                    
                    // Save this new data point to our database
                    await saveToFirestore(lat, lng, sos, timestamp);

                } else if (!data.entry_id) {
                     showError("ThingSpeak channel is empty. Waiting for data...");
                }
            } catch (err) {
                console.error("Fetch Error:", err);
                showError(`Error fetching data: ${err.message}`);
            } finally {
                loader.classList.add('hidden'); 
            }
        }

        /**
         * Updates the live UI, including the new map.
         */
        function updateLiveUI(lat, lng, sos, timestamp) {
            // Update text displays
            latDisplay.textContent = lat;
            lngDisplay.textContent = lng;
            lastUpdateDisplay.textContent = timestamp.toLocaleString();

            // Update SOS status box
            if (sos === 1) {
                sosStatusBox.className = 'p-6 rounded-lg shadow-lg bg-red-500 text-white animate-pulse';
                sosStatusText.textContent = 'ALERT!';
            } else {
                sosStatusBox.className = 'p-6 rounded-lg shadow-lg bg-green-500 text-white';
                sosStatusText.textContent = 'SAFE';
            }

            // --- THIS IS THE GOOGLE MAPS UPGRADE ---
            // Create the new URL for the map embed
            const mapUrl = `https://maps.google.com/maps?q=${lat},${lng}&t=&z=15&ie=UTF8&iwloc=&output=embed`;
            const linkUrl = `https://maps.google.com?q=${lat},${lng}`;
            
            // Set the `src` of the iframe to the new URL to move the pin
            mapIframe.src = mapUrl;
            // Update the "Open in Google Maps" link
            mapLink.href = linkUrl;
        }

        /**
         * Saves the fetched data to Firestore.
         */
        async function saveToFirestore(lat, lng, sos, timestamp) {
            if (!db) return; // Don't save if DB isn't ready

            try {
                // Save every single location update to locationHistory
                await addDoc(locationHistoryCollection, {
                    lat: lat,
                    lng: lng,
                    timestamp: timestamp
                });

                // This logic is now correct.
                // The Wokwi (v6) code sends field3=1.
                // This 'if' block will now run and save the alert.
                if (sos === 1) {
                    console.log("SOS === 1 detected. Saving to Firestore...");
                    await addDoc(alertHistoryCollection, {
                        timestamp: timestamp,
                        location: { lat: lat, lng: lng }
                    });
                }
            } catch (err) {
                console.error("Firestore write error:", err);
                showError(`Error saving data: ${err.message}`);
            }
        }

        function showError(message) {
            if(errorBox) {
                errorBox.textContent = message;
                errorBox.classList.remove('hidden');
            }
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            // Assign all DOM elements now that the page is loaded
            configScreen = document.getElementById('config-screen');
            dashboardScreen = document.getElementById('dashboard-screen');
            startButton = document.getElementById('start-button');
            channelIdInput = document.getElementById('channel-id');
            apiKeyInput = document.getElementById('api-key');
            errorBox = document.getElementById('error-box');
            latDisplay = document.getElementById('lat-display');
            lngDisplay = document.getElementById('lng-display');
            lastUpdateDisplay = document.getElementById('last-update');
            sosStatusBox = document.getElementById('sos-status-box');
            sosStatusText = document.getElementById('sos-status-text');
            loader = document.getElementById('loader');
            locationHistoryList = document.getElementById('location-history-list');
            alertHistoryList = document.getElementById('alert-history-list');
            mapIframe = document.getElementById('map-iframe'); // Map element
            mapLink = document.getElementById('map-link');     // Map link element

            // Start Firebase
            initFirebase();

            // Attach listener to the "Start" button
            startButton.addEventListener('click', () => {
                channelId = channelIdInput.value;
                readApiKey = apiKeyInput.value;
                if (!channelId || !readApiKey) {
                    showError("Please enter both Channel ID and Read API Key.");
                    return;
                }
                errorBox.classList.add('hidden');
                configScreen.classList.add('hidden');
                dashboardScreen.classList.remove('hidden');

                // Start monitoring
                fetchFromThingSpeak(); // Fetch immediately
                monitoringInterval = setInterval(fetchFromThingSpeak, 15000); // Then fetch every 15s
            });
        });
    </script>

    <!-- Basic styling -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Simple spinner */
        #loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Header -->
    <nav class="bg-white shadow-md">
        <div class="max-w-6xl mx-auto px-4 py-4">
            <h1 class="text-2xl font-bold text-gray-800">Smart Cane Dashboard</h1>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto p-4 mt-6">
        <!-- Error Box -->
        <div id="error-box" class="hidden p-4 mb-4 text-sm text-red-700 bg-red-100 rounded-lg" role="alert"></div>

        <!-- ===== Configuration Screen ===== -->
        <section id="config-screen" class="bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-xl font-semibold mb-4">Setup Monitoring</h2>
            <p class="text-gray-600 mb-4">Enter your ThingSpeak credentials to link your dashboard.</p>
            <div class="space-y-4">
                <div>
                    <label for="channel-id" class="block text-sm font-medium text-gray-700">ThingSpeak Channel ID</label>
                    <input type="text" id="channel-id" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g., 1234567">
                </div>
                <div>
                    <label for="api-key" class="block text-sm font-medium text-gray-700">ThingSpeak Read API Key</label>
                    <input type="text" id="api-key" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g., YOUR_READ_API_KEY">
                </div>
                <button id="start-button" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-blue-700">
                    Start Monitoring
                </button>
            </div>
        </section>

        <!-- ===== Dashboard Screen (Hidden by default) ===== -->
        <section id="dashboard-screen" class="hidden">
            
            <!-- NEW Grid Layout: 1/3 for stats, 2/3 for map -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">

                <!-- Column 1: Live Status Boxes -->
                <div class="lg:col-span-1 space-y-6">
                    <!-- SOS Status -->
                    <div id="sos-status-box" class="p-6 rounded-lg shadow-lg bg-gray-400 text-white">
                        <div class="flex items-center justify-between">
                            <h3 class="text-lg font-semibold">SOS Status</h3>
                            <div id="loader" class="hidden"></div>
                        </div>
                        <p id="sos-status-text" class="text-4xl font-bold mt-2">Waiting...</p>
                        <p class="text-sm opacity-80">Live from device</p>
                    </div>
                    
                    <!-- Location Text (still useful) -->
                    <div class="p-6 bg-white rounded-lg shadow-lg">
                        <h3 class="text-lg font-semibold text-gray-800">Last Seen Location</h3>
                        <p class="text-2xl font-bold text-blue-600 mt-2">
                            Lat: <span id="lat-display">--.------</span>
                        </U>
                        <p class="text-2xl font-bold text-blue-600">
                            Lng: <span id="lng-display">--.------</span>
                        </p>
                    </div>

                    <!-- Last Update Time -->
                    <div class="p-6 bg-white rounded-lg shadow-lg">
                        <h3 class="text-lg font-semibold text-gray-800">Last Update</h3>
                        <p id="last-update" class="text-xl font-bold text-gray-600 mt-4">
                            Waiting for data...
                        </p>
                    </div>
                </div>

                <!-- Column 2: Live Map (NEW) -->
                <div class="p-6 bg-white rounded-lg shadow-lg lg:col-span-2">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Live Map</h3>
                    <div class="mt-4" style="height: 450px; width: 100%;">
                        <!-- The iframe will be updated by JavaScript -->
                        <iframe
                            id="map-iframe"
                            width="100%"
                            height="100%"
                            style="border:0"
                            loading="lazy"
                            allowfullscreen
                            referrerpolicy="no-referrer-when-downgrade"
                            src="https://maps.google.com/maps?q=12.8406,80.1534&t=&z=15&ie=UTF8&iwloc=&output=embed">
                        </iframe>
                    </div>
                    <a id="map-link" href="https://maps.google.com?q=12.8406,80.1534" target="_blank" class="inline-block mt-3 text-blue-600 hover:underline">Open in Google Maps</a>
                </div>
            </div>

            <!-- History Section (Unchanged) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Location History -->
                <div class="bg-gray-50 p-6 rounded-lg shadow-lg">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Location History</h3>
                    <ul id="location-history-list" class="max-h-96 overflow-y-auto space-y-2">
                        <li class="text-gray-500">Loading history...</li>
                    </ul>
                </div>

                <!-- Alert History -->
                <div class="bg-red-50 p-6 rounded-lg shadow-lg">
                    <h3 class="text-xl font-semibold text-red-800 mb-4">SOS Alert History</h3>
                    <ul id="alert-history-list" class="max-h-96 overflow-y-auto space-y-2">
                        <li class="text-gray-500">Loading history...</li>
                    </ul>
                </div>
            </div>

        </section>

    </main>
</body>
</html>